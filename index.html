<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="rgb(71, 154, 102)">
    <title>UnicoCampania</title>
    <link rel="icon" type="image/x-icon" href="./favicon.ico">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="./apple-touch-icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:ital,wght@0,300..900;1,300..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./style.css">
</head>
<body>

    <header class="nav">
        <div class="nav__left">
            <img src="./images/left-arrow.png" height="15" alt="back-img">
        </div>
        <h3 class="nav__title">Ticket attivo</h3>
        <div class="nav__right"></div>
    </header>

    <main>
        <div class="box">

            <div class="box__pre-header">
                <img src="./images/logo-unico.jpeg" class="logo-unico" alt="logo unico" width="50">
                <h2 class="box__title">
                    unico - na 4 mensile integrato
                </h2>
                <p class="box__par">
                    L'abbonamento va attivato entro il giorno 15 del mese di utilizzo. Valido fino alle ore 24:00 dell'ultimo giorno del mese solare di attivazione.
                </p>
            </div>

            <div class="box box--secondary">
                <h3 class="box__title box__title--secondary">
                    Controllo e validazione
                    <div class="arrow-right">
                        <span class="img-arrow-right"></span>
                    </div>
                </h3>
                <div class="qr-code">
                    <img src="./images/qrcode.png" height="180" alt="qrcode" alt="qrcode">
                </div>
                <div class="flex time-check">
                    <span id="time"></span>
                    <span id="code-validation">930</span>
                </div>
            </div>

            <section class="loader">
                <video autoplay muted playsinline loop>
                    <source src="./videos/loader.mp4" type="video/mp4">
                </video>
            </section>

            <section class="cards">

                <div class="card card--green">
                    <p class="card__text">
                        Da <b>CASERTA</b> a <b>NAPOLI</b>
                    </p>
                    <p class="card__text">
                        <span class="card__label" style="margin-bottom: 0;">
                            Valida fino al:
                        </span>
                        <span id="date-end"></span>
                    </p>
                    <p class="card__text">
                        <span class="card__label">
                            Attivato il:
                        </span>
                        <strong>
                            <span id="date-start"></span>
                            -
                            <span>06:50</span>
                        </strong>
                    </p>
                </div>



                <div class="date-emission-container">
                    <span class="date-emission" style="margin-bottom: 0;">
                        Emesso il:<br>
                        <strong>
                            <span id="date-activated"></span>
                            -
                            <span>06:21</span>
                        </strong>
                    </span>
                </div>
            </section>

            <div class="flex price-footer">
                <h5>Costo</h5>
                <strong>81,90 €</strong>
            </div>

            <div class="accordion">
                <div class="flex accordion__title">
                    <strong>
                        Dettagli
                    </strong>
                    <strong id="toggle-accordion">
                        <span class="accordion__read-all">
                            Leggi Tutto
                        </span>
                        <span class="arrow-accordion">
                            <span class="img-arrow-accordion"></span>
                        </span>
                    </strong>
                </div>
                <p>
                    L'abbonamento va attivato entro il giorno 15 del mese di utilizzo. Valido fino alle ore 24:00 dell'ultimo giorno del mese solare di attivazione.
                </p>
            </div>

            <div class="flex details-footer">
                <span>
                    Codice Ticket:
                </span>
                <span>
                    8509/791800
                </span>
            </div>

            <div class="flex details-footer">
                <span>
                    PNR:
                </span>
                <span>
                    UNG99223SE
                </span>
            </div>



        </div>
    </main>

    <footer></footer>

    <script>

            const d = new Date();
            let year = d.getFullYear(),
                month = d.getMonth(),
                humanMonth = (month < 9) ? '0' + (month + 1) : (month + 1);

            let hour = d.getHours();
            let minutes = d.getMinutes();
                minutes =  minutes <= 9 ? '0' + minutes : minutes;
            let seconds = d.getSeconds();
                seconds =  seconds <= 9 ? '0' + seconds : seconds;

            let time = `${hour}:${minutes}:${seconds}`;

            document.getElementById("time").innerHTML = time;
            document.getElementById('date-end').textContent = `${getLastDay(year, month)}/${humanMonth}/${year}`;
            document.getElementById('date-start').textContent = `01/${humanMonth}/${year}`;
            document.getElementById('date-activated').textContent = `01/${humanMonth}/${year}`;

        setInterval(function() {
            const d = new Date();
            let hour = d.getHours();
            let minutes = d.getMinutes();
                minutes =  minutes <= 9 ? '0' + minutes : minutes;
            let seconds = d.getSeconds();
                seconds =  seconds <= 9 ? '0' + seconds : seconds;
            let time = `${hour}:${minutes}:${seconds}`;

            document.getElementById("time").innerHTML = time;
        }, 1000);

        // Funzione per ricavare l'ultimo giorno del mese.
        function getLastDay(y,m){
            return  new Date(y, m +1, 0).getDate();
        }


        // Funzione per toggle accordion.
        const toggle = document.getElementById("toggle-accordion");
        const accordion = toggle.closest(".accordion");
        const content = accordion.querySelector("p");
        const arrow = toggle.querySelector(".arrow-accordion");

        toggle.addEventListener("click", function() {
            if (content.classList.contains("open")) {
                content.style.height = "0";
                content.classList.remove("open");
                arrow.classList.remove("open-arrow");
            } else {
                content.style.height = content.scrollHeight + "px";
                content.classList.add("open");
                arrow.classList.add("open-arrow");
            }
        });


        // Registro Service Worker
        if("serviceWorker" in navigator){
            navigator.serviceWorker.register("sw.js").then(registration => {
                console.log("SW Registered");
                console.log(registration);

                // Rileva aggiornamenti
                registration.onupdatefound = () => {
                    const newSW = registration.installing;
                    newSW.onstatechange = () => {
                        if (newSW.state === "installed" && navigator.serviceWorker.controller) {
                            // Disabilita lo scroll del body
                            document.body.style.overflow = "hidden";

                            // Crea overlay scuro trasparente
                            const overlay = document.createElement("div");
                            overlay.style.position = "fixed";
                            overlay.style.top = "0";
                            overlay.style.left = "0";
                            overlay.style.width = "100%";
                            overlay.style.height = "100%";
                            overlay.style.background = "rgba(0, 0, 0, 0.4)";
                            overlay.style.display = "flex";
                            overlay.style.justifyContent = "center";
                            overlay.style.alignItems = "center";
                            overlay.style.zIndex = "9999";

                            // Crea popup stile iOS
                            const modal = document.createElement("div");
                            modal.style.background = "#f2f2f7";
                            modal.style.color = "#000";
                            modal.style.padding = "20px";
                            modal.style.borderRadius = "20px";
                            modal.style.boxShadow = "0 4px 20px rgba(0,0,0,0.3)";
                            modal.style.maxWidth = "300px";
                            modal.style.textAlign = "center";
                            modal.style.fontFamily = "-apple-system, BlinkMacSystemFont, 'Segoe UI', Rubik, Oxygen";

                            modal.innerHTML = `
                                <div style="font-size:17px; font-weight:600; margin-bottom:10px;">Nuova versione</div>
                                <div style="font-size:15px; margin-bottom:20px;">È disponibile un aggiornamento dell'app.</div>
                                <button id="reload-btn" style="
                                    width: 100%;
                                    padding: 10px;
                                    background: #007aff;
                                    color: white;
                                    border: none;
                                    border-radius: 12px;
                                    font-size: 16px;
                                    cursor: pointer;
                                ">Aggiorna</button>
                            `;

                            overlay.appendChild(modal);
                            document.body.appendChild(overlay);

                            document.getElementById("reload-btn").onclick = () => {
                                if (registration.waiting) {
                                    registration.waiting.postMessage("SKIP_WAITING");
                                }
                                window.location.reload();
                            };
                        }

                    };
                };

            }).catch(error => {
                console.log("Registrazione SW fallita");
                console.log(error);
            });

            // Ascolta il messaggio dal SW per skipWaiting
            navigator.serviceWorker.addEventListener("controllerchange", () => {
                window.location.reload();
            });
        }

    </script>
</body>
</html>
